# Readme:
# .gut/manifest.toml needs to contain the manifest for the speller bundle
# The Divvun CI encryption key 'DIVVUN_KEY' needs to be added as a secret 

name: "Build Speller Archives and Bundles"
on: push

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          repository: giellalt/giella-core
          path: giella-core
      - uses: actions/checkout@v2
        with:
          repository: giellalt/giella-shared
          path: giella-shared
      - uses: actions/checkout@v2
        with:
          path: lang
      - name: Install dependencies
        uses: divvun/actions/lang/install-deps@master
        with:
          sudo: true
      - name: Build
        uses: divvun/actions/lang/build@master
        with:
          fst: foma, hfst
      - name: Upload spellers
        uses: actions/upload-artifact@v2
        with:
          name: spellers
          path: 'lang/build/tools/spellcheckers/*-mobile.zhfst'
  bundle:
    needs: build
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: true
      matrix:
        include:
          - type: speller_macos
            os: macos-latest
          - type: speller_mobile
            os: macos-latest
          - type: speller_win
            os: windows-latest
          - type: speller_win_mso
            os: windows-latest
    steps:
      - uses: actions/checkout@v2
      - name: Setup Divvun CI
        uses: divvun/actions/setup@master
        with:
          key: ${{ secrets.DIVVUN_KEY }}
      - name: Download Spellers
        uses: actions/download-artifact@v2
        with:
          name: spellers
      - name: Run Divvun Bundler
        id: bundler
        uses: divvun/actions/speller/bundle@master
        with:
          bundleType: ${{ matrix.type }}
          manifest: ".gut/manifest.toml"
      - name: Upload installer
        uses: actions/upload-artifact@v2
        with:
          name: installer
          path: "${{ steps.bundler.outputs.bundle }}"
      - name: Deploy to Pahkat
        uses: divvun/actions/speller/deploy@master
        with:
          payload: "${{ steps.bundler.outputs.bundle }}"
          bundleType: ${{ matrix.type }}
          manifest: ".gut/manifest.toml"

